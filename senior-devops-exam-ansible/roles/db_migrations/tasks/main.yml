---
# roles/db_migrations/tasks/main.yml

- name: Ensure aws CLI is available on control node
  delegate_to: localhost
  run_once: true
  ansible.builtin.command: aws --version
  register: aws_version
  changed_when: false

- name: Fail if aws CLI is not installed
  delegate_to: localhost
  run_once: true
  ansible.builtin.fail:
    msg: "aws CLI not found on control node. Install awscli before running DB migrations."
  when: aws_version.rc != 0

- name: Fetch DB credentials from AWS Secrets Manager
  delegate_to: localhost
  run_once: true
  ansible.builtin.command: >
    aws secretsmanager get-secret-value
    --secret-id {{ rds_secret_arn }}
    --region {{ aws_region }}
    --query SecretString
    --output text
  register: db_secret_raw
  changed_when: false

- name: Parse DB secret JSON
  delegate_to: localhost
  run_once: true
  ansible.builtin.set_fact:
    db_secret: "{{ db_secret_raw.stdout | from_json }}"

- name: Set DB connection variables from secret or vault fallback
  delegate_to: localhost
  run_once: true
  ansible.builtin.set_fact:
    db_host: >-
      {{ db_secret.host
         | default(db_secret.address, true)
         | default(fallback_db_host, true) }}
    db_name: >-
      {{ db_secret.dbname
         | default(db_secret.db_name, true)
         | default(fallback_db_name, true) }}
    db_user: >-
      {{ db_secret.username
         | default(fallback_db_username, true) }}
    db_password: >-
      {{ db_secret.password
         | default(fallback_db_password, true) }}



# Example: run MySQL migrations from control node using mysql client.
# Adjust this to match your actual RDS engine + client (psql, sqlcmd, etc.)

- name: Upload migration script to control node temp (if using template/copy)
  delegate_to: localhost
  run_once: true
  ansible.builtin.copy:
    src: "files/migrations/001_init.sql"
    dest: "/tmp/logviewer_001_init.sql"
  when: migrations_enabled | default(true)

# We are on the Ansible control node here.
# For a real environment you would install the proper SQL Server client (sqlcmd)
# and uncomment the sqlcmd line below.

- name: Show DB migration command that would run against RDS
  delegate_to: localhost
  run_once: true
  ansible.builtin.debug:
    msg: >
      Would run migration against host={{ db_host }}, db={{ db_name }},
      user={{ db_user }} using /tmp/logviewer_001_init.sql

- name: Run DB migration script against RDS (documented example)
  delegate_to: localhost
  run_once: true
  ansible.builtin.shell: |
    echo "Simulating migration against {{ db_host }} / {{ db_name }}"
    # Example real command for SQL Server (commented for the exam environment):
    # sqlcmd -S {{ db_host }},1433 -U {{ db_user }} -P '{{ db_password }}' \
    #   -d {{ db_name }} -i /tmp/logviewer_001_init.sql
  args:
    executable: /bin/bash
  register: db_migration_result
  changed_when: false
  ignore_errors: true

- name: Debug DB migration result
  delegate_to: localhost
  run_once: true
  ansible.builtin.debug:
    var: db_migration_result.stdout

- name: Debug DB migration success
  delegate_to: localhost
  run_once: true
  ansible.builtin.debug:
    msg: "DB migrations completed successfully against {{ db_host }}/{{ db_name }}"
